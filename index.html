<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadhaiSetu AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        .animate-pulse-ring { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .animate-breathe { animation: breathe 8s infinite ease-in-out; }
        .markdown-table { width: 100%; border-collapse: collapse; border: 2px solid #0e7490; margin-bottom: 16px; font-size: 14px; font-family: sans-serif; }
        .markdown-table th { border: 1px solid #0e7490; padding: 10px; background-color: #cffafe; color: #155e75; font-weight: bold; text-align: center; }
        .markdown-table td { border: 1px solid #0e7490; padding: 8px; color: #1f2937; vertical-align: top; white-space: pre-wrap; }
        .markdown-table tr:nth-child(even) { background-color: #f0fdfa; }
        .prose strong { font-weight: 800; color: #000; }
        .prose h3 { font-size: 1.125rem; font-weight: 700; color: #164e63; border-bottom: 2px solid rgba(6,182,212,0.3); padding-bottom: 0.25rem; margin-top: 1.5rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="bg-white h-screen overflow-hidden text-gray-800 font-sans selection:bg-cyan-200 selection:text-cyan-900">

    <div id="app" class="relative h-full w-full">
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="hidden absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center text-center p-4 overflow-hidden">
            <div class="absolute w-96 h-96 bg-cyan-500/20 rounded-full blur-3xl -top-20 -left-20"></div>
            <div class="absolute w-96 h-96 bg-blue-500/20 rounded-full blur-3xl bottom-10 right-10"></div>
            <div class="relative flex items-center justify-center w-24 h-24 mb-8 z-10 animate-float bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl shadow-lg shadow-cyan-500/30 text-white">
                <i data-lucide="shield" class="absolute w-[120%] h-[120%] opacity-20"></i>
                <i data-lucide="graduation-cap" class="w-12 h-12 relative z-10"></i>
            </div>
            <h1 class="text-5xl font-extrabold text-white mb-2 z-10 tracking-tight">Padhai<span class="text-cyan-400">Setu</span> AI</h1>
            <p class="text-gray-400 mb-12 z-10 max-w-sm">Aapka Smart Educational Assistant. Login karein aur padhai shuru karein!</p>
            <div class="flex flex-col gap-4 w-full max-w-sm z-10 px-4">
                <button id="btn-login-google" class="w-full bg-white text-black py-3.5 rounded-xl font-bold text-lg hover:bg-gray-100 hover:scale-105 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)] flex items-center justify-center gap-3">
                    Continue with Google
                </button>
                <button id="btn-login-guest" class="w-full bg-slate-800/80 text-gray-300 py-3.5 rounded-xl font-bold text-lg hover:bg-slate-700 hover:text-white transition-all border border-slate-700 backdrop-blur-sm">Guest Login</button>
            </div>
        </div>

        <!-- 2. ONBOARDING SCREEN -->
        <div id="onboarding-screen" class="hidden absolute inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md space-y-4">
                <div class="text-center mb-6">
                    <div class="relative flex items-center justify-center w-16 h-16 mx-auto mb-2 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl text-white"><i data-lucide="graduation-cap" class="w-8 h-8"></i></div>
                    <h2 class="text-2xl font-bold text-gray-800">Setup Profile</h2>
                </div>
                <select id="onboard-class" class="w-full p-3 border rounded-lg bg-white"><option value="">Select Class</option></select>
                <select id="onboard-state" class="w-full p-3 border rounded-lg bg-white"><option value="">Select State</option></select>
                <div id="board-select-container" class="hidden"><select id="onboard-board" class="w-full p-3 border rounded-lg bg-white"><option value="">Select Board</option></select></div>
                <button id="btn-save-profile" disabled class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold hover:bg-cyan-700 disabled:opacity-50 mt-2 transition">Start Learning</button>
            </div>
        </div>

        <!-- 3. MAIN INTERFACE -->
        <div id="main-interface" class="hidden flex h-full">
            <div id="sidebar" class="-translate-x-full md:translate-x-0 fixed md:relative z-40 w-72 h-full bg-gray-900 text-white transition-transform duration-300 flex flex-col border-r border-gray-800 shadow-2xl">
                <div class="p-4 flex justify-between items-center">
                    <div class="font-bold text-xl flex items-center gap-2">
                         <div class="w-8 h-8 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center"><i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i></div>
                         PadhaiSetu
                    </div>
                    <button id="btn-close-sidebar" class="md:hidden p-1 hover:bg-gray-800 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-3">
                    <button id="btn-new-chat" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-xl flex gap-2 items-center justify-center text-sm font-bold transition shadow-lg shadow-cyan-900/20"><i data-lucide="plus" class="w-5 h-5"></i> New Chat</button>
                </div>
                <div class="px-2 mb-2 flex gap-1 bg-gray-800 p-1 mx-3 rounded-lg">
                    <button data-history-tab="chat" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition bg-gray-600 text-white shadow">CHATS</button>
                    <button data-history-tab="swadhyay" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-gray-200">PAPERS</button>
                    <button data-history-tab="smartclass" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-gray-200">TOPICS</button>
                </div>
                <div class="px-4 py-2 space-y-1">
                    <button id="btn-nav-smartclass" class="w-full flex items-center gap-3 p-2 rounded-lg text-sm transition text-gray-300 hover:bg-gray-800"><i data-lucide="monitor-play" class="w-4 h-4"></i> Smart Class <span class="ml-auto text-[10px] bg-cyan-500 text-black px-1.5 rounded font-bold">PRO</span></button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto px-3 space-y-1 scrollbar-hide"></div>
                <div class="p-4 bg-gray-900 border-t border-gray-800">
                    <div class="flex items-center gap-3">
                        <div id="user-avatar" class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center font-bold">G</div>
                        <p id="user-name" class="text-sm truncate flex-1 font-medium">Guest Student</p>
                        <button id="btn-logout"><i data-lucide="log-out" class="w-5 h-5 text-gray-400 hover:text-white"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col h-full relative bg-white">
                <header class="h-16 border-b flex items-center justify-between px-4 bg-white/80 backdrop-blur-md z-30 sticky top-0">
                    <button id="btn-open-sidebar" class="md:hidden p-2"><i data-lucide="menu" class="w-6 h-6 text-gray-600"></i></button>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1.5 border border-gray-200 cursor-pointer relative group hover:border-cyan-400 transition">
                            <span class="text-cyan-600"><i id="current-voice-icon" data-lucide="heart" class="w-4 h-4"></i></span>
                            <select id="voice-select" class="bg-transparent border-none text-sm font-medium text-gray-700 focus:ring-0 cursor-pointer appearance-none pr-4 outline-none"></select>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 absolute right-2 pointer-events-none"></i>
                        </div>
                    </div>
                    <button id="btn-nav-swadhyay" class="flex items-center gap-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-md hover:shadow-lg hover:scale-105 transition transform"><i data-lucide="indian-rupee" class="w-4 h-4"></i> Earnings</button>
                </header>

                <div id="tab-chat" class="flex-1 overflow-y-auto p-4 space-y-6 pb-24 scroll-smooth">
                    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center p-8">
                        <div class="w-20 h-20 bg-cyan-50 rounded-full flex items-center justify-center mb-6"><i data-lucide="sparkles" class="w-10 h-10 text-cyan-500"></i></div>
                        <h2 id="welcome-text" class="text-2xl font-bold text-gray-800 mb-2">Namaste!</h2>
                        <p class="text-gray-500 max-w-sm mb-8">Ask me anything from your syllabus.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg">
                            <button id="btn-start-voice-empty" class="flex items-center gap-3 p-4 bg-gray-900 text-white rounded-xl shadow-lg hover:shadow-xl transition group transform hover:-translate-y-1"><div class="bg-white/10 p-2 rounded-full group-hover:bg-white/20"><i data-lucide="headphones" class="w-6 h-6"></i></div><div class="text-left"><p class="font-bold">Voice Mode</p><p class="text-xs opacity-70">Tap Mic to Chat</p></div></button>
                            <div class="flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:border-cyan-400 transition cursor-default"><div class="bg-cyan-50 p-2 rounded-full"><i data-lucide="upload" class="w-6 h-6 text-cyan-600"></i></div><div class="text-left"><p class="font-bold text-gray-800">Solve Paper</p><p class="text-xs text-gray-500">Use Earnings button</p></div></div>
                        </div>
                    </div>
                </div>

                <div id="tab-swadhyay" class="hidden flex-1 overflow-y-auto p-6 bg-gray-50 relative">
                    <div class="sticky top-0 z-50 flex justify-end mb-2">
                        <button id="btn-close-swadhyay" class="bg-white/90 p-2 rounded-full shadow-md text-red-500 hover:bg-red-50 border border-gray-200 backdrop-blur-sm transition-all transform active:scale-95"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-cyan-800 border-b pb-4"><div class="bg-cyan-100 p-2 rounded-full"><i data-lucide="upload" class="w-6 h-6 text-cyan-600"></i></div> Swadhyay Paper / Question Paper Solver</h2>
                        <div id="swadhyay-upload-area">
                            <div id="swadhyay-dropzone" class="bg-white p-10 rounded-3xl shadow-lg border-2 border-dashed border-cyan-200 mb-8 relative group cursor-pointer hover:border-cyan-500 hover:bg-cyan-50/20 transition-all flex flex-col items-center justify-center min-h-[250px]">
                                <div class="bg-blue-50 p-5 rounded-full group-hover:bg-blue-100 transition shadow-sm mb-4"><i data-lucide="scan-line" class="w-12 h-12 text-blue-500 animate-pulse"></i></div>
                                <h3 class="text-xl font-bold text-gray-800">Scan Question Paper</h3>
                                <p class="text-sm text-gray-500 mt-1">Upload PDF, Image or Text file</p>
                                <div id="swadhyay-file-status" class="hidden mt-6 px-5 py-2 bg-green-100 text-green-800 rounded-full flex items-center gap-2 font-bold shadow-sm animate-in zoom-in"><i data-lucide="file-check" class="w-5 h-5"></i><span id="swadhyay-filename"></span> Ready</div>
                            </div>
                            <input type="file" id="swadhyay-file-input" class="hidden" accept=".jpg,.jpeg,.png,.pdf,.txt">
                            <button id="btn-solve-swadhyay" disabled class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-cyan-500/40 transition-all disabled:opacity-50 flex items-center justify-center gap-3 transform active:scale-95"><i data-lucide="sparkles" class="w-6 h-6"></i> Solve Now</button>
                        </div>
                        <div id="swadhyay-solution-area" class="hidden mt-8 bg-white rounded-2xl shadow-xl border border-cyan-100 overflow-hidden animate-in fade-in slide-in-from-bottom-4">
                            <div id="solution-print-area" class="p-10 bg-white relative">
                                <h3 class="text-2xl font-bold text-cyan-800 border-b-2 border-cyan-500 pb-4 mb-6">PadhaiSetu Solution</h3>
                                <div id="solution-content" class="prose max-w-none text-gray-800 font-sans leading-relaxed text-lg"></div>
                            </div>
                            <div class="p-6 bg-gray-50 border-t flex justify-end gap-4 no-print">
                                <button id="btn-pdf-download" class="flex items-center gap-2 bg-white text-red-600 font-bold px-6 py-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5"><i data-lucide="download" class="w-5 h-5"></i> Download PDF</button>
                                <button id="btn-solution-listen" class="flex items-center gap-2 text-cyan-600 font-medium"><i data-lucide="volume-2" class="w-5 h-5"></i> Listen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-visuals" class="hidden flex-1 bg-gray-950 text-white flex flex-col h-full relative overflow-hidden font-sans">
                     <div class="z-10 flex flex-col h-full p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold flex items-center gap-2 text-cyan-400 tracking-wide"><i data-lucide="school" class="w-6 h-6 text-cyan-400"></i> Smart Class <span class="text-[10px] bg-cyan-500/20 text-cyan-300 px-1.5 py-0.5 rounded border border-cyan-500/30">VISUAL LEARNING</span></h2>
                            <button id="btn-close-smartclass" class="p-2 bg-white/10 rounded-full hover:bg-red-500/20 hover:text-red-400 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div id="visualizer-container" class="flex-1 rounded-2xl relative overflow-hidden flex items-center justify-center mb-4 bg-black border border-cyan-500/20 shadow-[0_0_30px_rgba(6,182,212,0.1)]">
                            <div id="visuals-placeholder" class="text-center text-gray-500 flex flex-col items-center">
                                <div class="w-24 h-24 bg-cyan-900/20 rounded-full flex items-center justify-center mb-4 border border-cyan-500/20"><i data-lucide="lightbulb" class="w-12 h-12 text-cyan-400/50"></i></div>
                                <p class="text-lg font-medium text-gray-400">What do you want to learn?</p>
                            </div>
                        </div>
                        <div class="bg-gray-900/80 backdrop-blur-xl p-4 rounded-2xl border border-cyan-500/20 shadow-lg">
                            <div id="visuals-input-group" class="flex flex-col gap-3">
                                <div class="flex gap-2 bg-black/40 p-1.5 rounded-xl border border-cyan-500/30 focus-within:border-cyan-500/60 transition-colors">
                                    <input id="visuals-topic-input" placeholder="e.g. Solar System, Heart..." class="flex-1 bg-transparent border-none text-white w-full focus:ring-0 outline-none text-sm placeholder-gray-500 px-2">
                                    <button id="btn-start-visuals" class="bg-cyan-600 hover:bg-cyan-500 text-black px-6 py-2 rounded-lg font-bold transition disabled:opacity-50 shadow-[0_0_10px_rgba(8,145,178,0.5)] flex items-center gap-2 text-sm"><i data-lucide="play" class="w-4 h-4 fill-current"></i> Start Class</button>
                                </div>
                            </div>
                            <div id="visuals-script-group" class="hidden flex flex-col gap-3">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-cyan-500 font-mono tracking-wider font-bold"><i data-lucide="school" class="w-3 h-3 inline mr-1"></i> SMART EXPLANATION</span>
                                    <div class="flex gap-2">
                                        <button id="btn-visuals-exit" class="text-gray-400 hover:text-white px-3 py-1.5 rounded-full hover:bg-white/10 transition">EXIT</button>
                                    </div>
                                </div>
                                <div class="max-h-32 overflow-y-auto pr-1 bg-black/20 p-2 rounded-lg border border-white/5"><p id="visuals-script-text" class="text-sm text-gray-300 leading-relaxed"></p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-earnings" class="hidden flex-1 p-6 flex flex-col items-center justify-center text-gray-500 relative">
                     <button id="btn-close-earnings" class="absolute top-6 right-6 p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
                     <i data-lucide="trending-up" class="w-16 h-16 text-gray-300 mb-4"></i>
                     <h3 class="text-xl font-bold">Earnings Dashboard</h3>
                     <p>Coming Soon</p>
                </div>

                <div id="chat-input-container" class="p-3 bg-white border-t sticky bottom-0 z-20">
                    <div class="max-w-3xl mx-auto relative">
                        <div id="attachment-menu" class="hidden absolute bottom-full left-0 mb-3 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 flex flex-col gap-1 w-48 animate-in slide-in-from-bottom-5 z-30">
                             <button id="btn-camera" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl text-left transition text-gray-700"><div class="bg-gray-100 p-2 rounded-full"><i data-lucide="camera" class="w-5 h-5"></i></div> Camera</button>
                             <button id="btn-document" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl text-left transition text-gray-700"><div class="bg-gray-100 p-2 rounded-full"><i data-lucide="paperclip" class="w-5 h-5"></i></div> Document / Photo</button>
                        </div>
                        <input type="file" id="chat-file-input" class="hidden" accept="*/*">
                        <input type="file" id="chat-camera-input" class="hidden" accept="image/*" capture="environment">
                        
                        <div id="chat-file-preview" class="hidden absolute bottom-full left-0 mb-4 p-2 bg-white rounded-xl shadow-lg border border-gray-100 animate-in fade-in slide-in-from-bottom-2 flex items-center gap-3">
                             <div id="preview-icon-area" class="h-16 w-16 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200 overflow-hidden"></div>
                             <span id="preview-filename" class="text-xs text-gray-600 max-w-[100px] truncate"></span>
                             <button id="btn-remove-attachment" class="absolute -top-2 -right-2 bg-gray-800 text-white rounded-full p-1 hover:bg-black"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>

                        <div class="flex items-end gap-3 bg-gray-100 p-2 rounded-[26px] border border-transparent focus-within:border-gray-300 focus-within:bg-white focus-within:shadow-sm transition-all">
                            <button id="btn-toggle-attach" class="p-3 rounded-full transition-transform bg-gray-200 hover:bg-gray-300 text-gray-700"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            <textarea id="chat-input" placeholder="Message PadhaiSetu..." class="flex-1 bg-transparent border-none focus:ring-0 resize-none max-h-32 py-3 text-gray-800 placeholder-gray-500 outline-none" rows="1"></textarea>
                            <div class="flex items-center gap-1">
                                <button id="btn-send-message" class="hidden p-3 bg-black text-white rounded-full hover:opacity-80 transition shadow-md animate-in zoom-in"><i data-lucide="send" class="w-5 h-5"></i></button>
                                <button id="btn-start-voice" class="p-3 bg-gray-900 text-white rounded-full hover:bg-gray-700 transition shadow-md ml-1"><i data-lucide="headphones" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="voice-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-between p-8 animate-in fade-in duration-300 backdrop-blur-xl">
             <div class="w-full flex justify-between text-white/80">
                <div class="flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-cyan-400"></i><span id="voice-mode-status">Voice Mode</span></div>
                <button id="btn-close-voice" class="p-2 bg-white/10 rounded-full hover:bg-white/20"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="flex-1 flex items-center justify-center">
                <div id="voice-orb" class="w-40 h-40 rounded-full bg-gray-800 transition-all duration-500 flex items-center justify-center"><i data-lucide="mic" class="w-12 h-12 text-gray-400"></i></div>
            </div>
            <div class="text-center mb-12"><p id="voice-text" class="text-2xl font-bold text-white mb-2">Tap Mic to Chat</p></div>
            <div class="flex justify-center pb-8"><button id="btn-voice-action" class="p-8 rounded-full bg-white text-black hover:scale-105 transition"><i data-lucide="mic" class="w-10 h-10"></i></button></div>
        </div>

        <div id="image-viewer" class="hidden fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200">
            <button id="btn-close-image" class="absolute top-4 right-4 p-3 bg-white/10 hover:bg-white/20 rounded-full text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            <img id="image-viewer-content" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, updateDoc, increment, collection, query, orderBy, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCxj9wQwwhkgWlJhKUjOsxLQIRvil-C5ns",
          authDomain: "padhaisetu-ced2a.firebaseapp.com",
          databaseURL: "https://padhaisetu-ced2a-default-rtdb.firebaseio.com",
          projectId: "padhaisetu-ced2a",
          storageBucket: "padhaisetu-ced2a.firebasestorage.app",
          messagingSenderId: "635163904849",
          appId: "1:635163904849:web:6b9715b832cb34330a6170"
        };
        const BACKEND_URL = "/api/gemini";
        const CLASSES = Array.from({ length: 12 }, (_, i) => `Class ${i + 1}`);
        const STATES = ["Gujarat", "Maharashtra", "Rajasthan", "Uttar Pradesh", "Bihar", "Madhya Pradesh", "Karnataka", "Tamil Nadu", "Delhi", "Punjab"];
        const BOARDS = ["CBSE", "ICSE", "GSEB", "MSBSHSE", "UPMSP", "RBSE"];
        const AI_VOICES = [
          { name: "Badi Didi (Caring)", id: "Aoede", icon: "heart", gender: "female", pitch: 1.0 }, 
          { name: "Bada Bhai (Cool)", id: "Fenrir", icon: "user", gender: "male", pitch: 0.9 },   
          { name: "Dost (Fun)", id: "Iapetus", icon: "smile", gender: "male", pitch: 1.0 },          
          { name: "Sir (Serious)", id: "Orus", icon: "book-open", gender: "male", pitch: 0.8 }   
        ];

        const appId = 'padhaisetu-ced2a';
        let app, auth, db, googleProvider;
        let currentUser = null;
        let userProfile = null;
        let currentMessages = [];
        let currentSessionId = null;
        let chatHistory = [];
        let swadhyayHistory = [];
        let smartClassHistory = [];
        let activeHistoryTab = 'chat';
        let attachedFile = null;
        let selectedVoice = "Aoede";
        let isVoiceMode = false;
        let voiceState = 'idle'; 
        let swadhyayPaper = null;
        let currentSmartSession = null;
        let mediaRecorder = null;
        let audioChunks = [];

        const el = id => document.getElementById(id);
        const show = id => el(id).classList.remove('hidden');
        const hide = id => el(id).classList.add('hidden');
        
        function init() {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                googleProvider = new GoogleAuthProvider();
                
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) {
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                        try {
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                userProfile = docSnap.data();
                                renderApp();
                            } else {
                                renderOnboarding();
                            }
                        } catch (e) { console.error(e); renderOnboarding(); }
                        setupRealtimeListeners(user.uid);
                    } else {
                        renderLogin();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error", e);
                alert("Firebase Error. Check console.");
            }
            
            if (window.lucide) lucide.createIcons();
            populateDropdowns();
            populateVoiceSelect();
            setupEventListeners();
        }

        async function callBackendAI(messages) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });
                
                if (!response.ok) throw new Error('API failed');
                const data = await response.json();
                
                if (data.text) return data.text;
                if (data.error) return `Error: ${data.error}`;
                return "AI did not return a valid response.";
            } catch (e) {
                console.error("Backend Call Error:", e);
                return "Sorry, I am having trouble connecting to the server.";
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.history-tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.history-tab-btn').forEach(b => {
                        b.classList.remove('bg-gray-600', 'text-white', 'shadow');
                        b.classList.add('text-gray-400', 'hover:text-gray-200');
                    });
                    btn.classList.remove('text-gray-400', 'hover:text-gray-200');
                    btn.classList.add('bg-gray-600', 'text-white', 'shadow');
                    activeHistoryTab = btn.getAttribute('data-history-tab');
                    renderSidebar();
                };
            });
            el('btn-login-google').onclick = async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) { await signInAnonymously(auth); } };
            el('btn-login-guest').onclick = async () => await signInAnonymously(auth);
            el('btn-logout').onclick = () => signOut(auth);
            el('btn-save-profile').onclick = saveProfile;
            el('onboard-class').onchange = checkOnboard;
            el('onboard-state').onchange = checkOnboard;
            el('onboard-board').onchange = checkOnboard;
            el('btn-new-chat').onclick = startNewChat;
            el('btn-send-message').onclick = handleSend;
            el('chat-input').onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
            el('chat-input').oninput = checkInput;
            el('chat-file-input').onchange = handleFile;
            el('chat-camera-input').onchange = handleFile;
            el('btn-remove-attachment').onclick = () => setAttachedFile(null);
            el('btn-toggle-attach').onclick = () => el('attachment-menu').classList.toggle('hidden');
            el('btn-camera').onclick = () => el('chat-camera-input').click();
            el('btn-document').onclick = () => el('chat-file-input').click();
            el('btn-start-voice').onclick = startVoiceMode;
            el('btn-start-voice-empty').onclick = startVoiceMode;
            el('btn-voice-action').onclick = toggleVoiceRecord;
            el('btn-close-voice').onclick = closeVoiceMode;
            el('btn-nav-swadhyay').onclick = () => switchTab('swadhyay');
            el('btn-close-swadhyay').onclick = () => switchTab('chat');
            el('swadhyay-dropzone').onclick = () => el('swadhyay-file-input').click();
            el('swadhyay-file-input').onchange = handleSwadhyayFile;
            el('btn-solve-swadhyay').onclick = solveSwadhyay;
            el('btn-pdf-download').onclick = downloadSolutionPDF;
            el('btn-nav-smartclass').onclick = () => { switchTab('visuals'); if(window.innerWidth < 768) hide('sidebar'); };
            el('btn-close-smartclass').onclick = () => switchTab('chat');
            el('btn-start-visuals').onclick = startVisualClass;
            el('btn-visuals-exit').onclick = exitVisuals;
            el('btn-open-sidebar').onclick = () => el('sidebar').classList.remove('-translate-x-full');
            el('btn-close-sidebar').onclick = () => el('sidebar').classList.add('-translate-x-full');
            el('voice-select').onchange = (e) => { selectedVoice = e.target.value; lucide.createIcons(); };
            el('btn-close-earnings').onclick = () => switchTab('chat');
            el('btn-solution-listen').onclick = () => {
                const text = el('solution-content').innerText;
                speakText(text);
            };
        }

        function populateDropdowns() {
            CLASSES.forEach(c => el('onboard-class').add(new Option(c, c)));
            STATES.forEach(s => el('onboard-state').add(new Option(s, s)));
            BOARDS.forEach(b => el('onboard-board').add(new Option(b, b)));
        }

        function populateVoiceSelect() {
            const select = el('voice-select');
            select.innerHTML = '';
            AI_VOICES.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name;
                select.appendChild(opt);
            });
            select.value = selectedVoice;
        }

        function resetViews() {
            hide('login-screen');
            hide('onboarding-screen');
            hide('main-interface');
        }

        function renderLogin() { resetViews(); show('login-screen'); }
        function renderOnboarding() { resetViews(); show('onboarding-screen'); }
        function renderApp() { resetViews(); show('main-interface'); updateUserUI(); }

        function updateUserUI() {
            if(currentUser) {
                el('user-name').textContent = currentUser.displayName || 'Guest Student';
                el('user-avatar').textContent = (currentUser.displayName?.[0] || 'G').toUpperCase();
            }
        }

        async function saveProfile() {
             const cls = el('onboard-class').value;
             const state = el('onboard-state').value;
             const board = el('onboard-board').value;
             if(currentUser && cls && state) {
                 const data = { class: cls, state, board, isPro: false, earnings: 0, uploads: 0, email: currentUser.email, displayName: currentUser.displayName || 'Guest' };
                 await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), data);
                 userProfile = data;
                 renderApp();
             }
        }

        function checkOnboard() {
             const cls = el('onboard-class').value;
             const state = el('onboard-state').value;
             const board = el('onboard-board').value;
             const needsBoard = cls === 'Class 10' || cls === 'Class 12';
             if(needsBoard) show('board-select-container'); else hide('board-select-container');
             el('btn-save-profile').disabled = !(cls && state && (!needsBoard || board));
        }

        function setupRealtimeListeners(uid) {
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'chats'), orderBy('updatedAt', 'desc')), (snap) => {
                chatHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'chat') renderSidebar();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'swadhyay'), orderBy('updatedAt', 'desc')), (snap) => {
                swadhyayHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'swadhyay') renderSidebar();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'smartclass'), orderBy('createdAt', 'desc')), (snap) => {
                smartClassHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'smartclass') renderSidebar();
            });
        }

        function renderSidebar() {
             const container = el('history-list');
             container.innerHTML = '';
             let list = activeHistoryTab === 'chat' ? chatHistory : (activeHistoryTab === 'swadhyay' ? swadhyayHistory : smartClassHistory);
             
             if(list.length === 0) {
                 container.innerHTML = `<div class="text-gray-600 text-sm text-center py-4">No recent items</div>`;
                 return;
             }

             list.forEach(item => {
                 const div = document.createElement('div');
                 let icon = 'message-circle';
                 let title = item.title || "Untitled";
                 if (activeHistoryTab === 'swadhyay') { icon = 'file-question'; title = item.title || "Paper"; }
                 else if (activeHistoryTab === 'smartclass') { icon = 'film'; title = item.topic || "Lesson"; }

                 div.className = `group flex items-center gap-3 p-3 rounded-lg text-sm transition cursor-pointer hover:bg-gray-800 text-gray-400 hover:text-gray-200 ${currentSessionId === item.id && activeHistoryTab === 'chat' ? 'bg-gray-800 text-white' : ''}`;
                 div.innerHTML = `
                    <i data-lucide="${icon}" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="truncate flex-1">${title}</span>
                    <button class="btn-del p-1.5 hover:bg-red-500/20 text-gray-500 hover:text-red-400 rounded transition opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                 `;
                 div.onclick = () => loadHistoryItem(item, activeHistoryTab);
                 div.querySelector('.btn-del').onclick = (e) => { e.stopPropagation(); deleteItem(item.id, activeHistoryTab); };
                 container.appendChild(div);
             });
             lucide.createIcons();
        }

        function loadHistoryItem(item, type) {
            if (type === 'chat') {
                currentSessionId = item.id;
                currentMessages = item.messages || [];
                renderMessages();
                switchTab('chat');
            } else if (type === 'swadhyay') {
                el('solution-content').innerHTML = parseMarkdown(item.solution);
                hide('swadhyay-upload-area');
                show('swadhyay-solution-area');
                switchTab('swadhyay');
            } else if (type === 'smartclass') {
                currentSmartSession = item;
                el('visuals-topic-input').value = item.topic;
                el('visuals-script-text').textContent = item.script;
                hide('visuals-input-group');
                show('visuals-script-group');
                const container = el('visualizer-container');
                container.innerHTML = item.imageSrc ? `<img src="${item.imageSrc}" class="max-w-full max-h-full object-contain animate-breathe">` : `<div class="text-cyan-400 text-xl font-bold">${item.topic}</div>`;
                switchTab('visuals');
            }
            if(window.innerWidth < 768) hide('sidebar');
        }

        async function deleteItem(id, type) {
            if(!confirm("Delete this?")) return;
            const col = type === 'smartclass' ? 'smartclass' : (type === 'swadhyay' ? 'swadhyay' : 'chats');
            try { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id)); } catch(e){console.error(e);}
            if(type==='chat' && currentSessionId===id) startNewChat();
        }

        function startNewChat() {
            currentSessionId = null;
            currentMessages = [];
            renderMessages();
            if(window.innerWidth < 768) hide('sidebar');
        }

        function renderMessages() {
            const container = el('tab-chat');
            Array.from(container.children).forEach(c => { if(c.id !== 'empty-state') c.remove(); });
            
            if(currentMessages.length === 0) { show('empty-state'); return; }
            hide('empty-state');

            currentMessages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                let contentHTML = '';
                if (msg.role === 'user') {
                     let fileHTML = '';
                     if (msg.file) {
                         if(msg.file.type === 'image') fileHTML = `<img src="${msg.file.data}" class="h-32 w-auto object-cover rounded-xl border border-gray-200 cursor-zoom-in mb-2 view-img-trigger">`;
                         else fileHTML = `<div class="flex items-center gap-2 bg-white p-3 rounded-lg border border-gray-200 mb-2"><i data-lucide="file-text" class="w-6 h-6 text-red-500"></i><span class="text-xs font-medium text-gray-700">${msg.file.name}</span></div>`;
                     }
                     contentHTML = `<div class="bg-gray-100 text-gray-900 rounded-[2rem] rounded-tr-sm px-5 py-3 max-w-[85%] shadow-sm border border-gray-100 self-end">${fileHTML}<div class="whitespace-pre-wrap text-sm font-medium">${escapeHtml(msg.content)}</div></div>`;
                } else {
                    contentHTML = `<div class="flex gap-3 w-full self-start group"><div class="relative flex items-center justify-center w-8 h-8 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-lg text-white shadow-md"><i data-lucide="graduation-cap" class="w-5 h-5"></i></div><div class="flex-1 text-gray-800 leading-relaxed pt-1">${msg.isLoading ? '<div class="flex gap-1 items-center h-6">Thinking...</div>' : `<div class="prose text-sm">${parseMarkdown(msg.content)}</div><div class="mt-3 flex gap-3 items-center"><button class="btn-speak flex items-center gap-1.5 p-1.5 px-3 bg-white hover:bg-gray-50 rounded-full text-gray-500 hover:text-cyan-600 transition text-xs font-bold border border-gray-200 shadow-sm"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i> <span>Listen</span></button></div>`}</div></div>`;
                }
                bubble.innerHTML = contentHTML;
                container.appendChild(bubble);
                const imgTrigger = bubble.querySelector('.view-img-trigger');
                if(imgTrigger) imgTrigger.onclick = () => showImage(imgTrigger.src);
                const speakBtn = bubble.querySelector('.btn-speak');
                if(speakBtn) speakBtn.onclick = () => speakText(msg.content);
            });
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        async function handleSend() {
            const inputEl = el('chat-input');
            const text = inputEl.value.trim();
            if (!text && !attachedFile) return;

            const userMsg = { role: 'user', content: text, file: attachedFile };
            currentMessages.push(userMsg);
            currentMessages.push({ role: 'assistant', content: '', isLoading: true }); // Use 'assistant' not 'ai'
            
            inputEl.value = '';
            setAttachedFile(null);
            renderMessages();
            
            try {
                // Prepare messages for Backend
                const sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                const apiMessages = [
                    { role: 'system', content: sysPrompt },
                    ...currentMessages.filter(m => !m.isLoading && m !== userMsg).map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }))
                ];
                
                // Add current message
                let content = text;
                if (userMsg.file) content += `\n[User attached file: ${userMsg.file.name}]`;
                apiMessages.push({ role: 'user', content });

                const aiText = await callBackendAI(apiMessages);
                
                currentMessages.pop();
                currentMessages.push({ role: 'assistant', content: aiText });
                saveChat();
                renderMessages();
                if(isVoiceMode) speakText(aiText);
            } catch (e) {
                currentMessages.pop();
                currentMessages.push({ role: 'assistant', content: "Network error." });
                renderMessages();
            }
        }

        function checkInput(e) {
             if(e.target.value.trim().length > 0 || attachedFile) show('btn-send-message'); else hide('btn-send-message');
        }

        function setAttachedFile(file) {
            attachedFile = file;
            if(file) {
                show('chat-file-preview');
                el('preview-filename').textContent = file.name;
                el('preview-icon-area').innerHTML = file.type === 'image' ? `<img src="${file.data}" class="w-full h-full object-cover">` : `<i data-lucide="file-text" class="w-8 h-8 text-gray-500"></i>`;
                lucide.createIcons();
                show('btn-send-message');
            } else {
                hide('chat-file-preview');
                if(el('chat-input').value.trim().length === 0) hide('btn-send-message');
            }
        }

        const handleFile = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = () => setAttachedFile({ data: reader.result, type: f.type.startsWith('image/')?'image':'file', name: f.name });
            reader.readAsDataURL(f);
            hide('attachment-menu');
        };

        function startVoiceMode() { isVoiceMode = true; show('voice-overlay'); updateVoiceStatus('idle'); }
        function closeVoiceMode() { isVoiceMode = false; window.speechSynthesis.cancel(); hide('voice-overlay'); }
        
        function updateVoiceStatus(status) {
            voiceState = status;
            const orb = el('voice-orb');
            const txt = el('voice-text');
            orb.className = "w-40 h-40 rounded-full transition-all duration-500 flex items-center justify-center ";
            if(status === 'idle') { orb.classList.add('bg-gray-800'); txt.textContent = "Tap Mic to Chat"; }
            else if (status === 'listening') { orb.classList.add('bg-blue-600', 'scale-110', 'shadow-lg'); txt.textContent = "Listening..."; }
            else if (status === 'processing') { orb.classList.add('bg-white', 'scale-90', 'animate-pulse'); txt.textContent = "Thinking..."; }
            else if (status === 'speaking') { orb.classList.add('bg-purple-600', 'scale-125'); txt.textContent = "Speaking..."; }
        }

        async function toggleVoiceRecord() {
            if(voiceState === 'idle') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        updateVoiceStatus('processing');
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        // Simulate STT/TTS via text fallback for stability
                        handleSendAudioStub(); 
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                    updateVoiceStatus('listening');
                    setTimeout(() => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 4000); 
                } catch(e) { alert("Mic error"); }
            } else if (voiceState === 'listening') { mediaRecorder.stop(); }
            else if (voiceState === 'speaking') { window.speechSynthesis.cancel(); updateVoiceStatus('idle'); }
        }

        async function handleSendAudioStub() {
             // Voice simulation
             const userMsg = { role: 'user', content: "ðŸŽ¤ [Voice Message]" };
             currentMessages.push(userMsg);
             renderMessages();
             
             try {
                const sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                const apiMessages = [
                    { role: 'system', content: sysPrompt },
                    { role: 'user', content: "I am speaking to you via voice. Please reply briefly in Hindi/English." }
                ];
                const text = await callBackendAI(apiMessages);
                currentMessages.push({ role: 'assistant', content: text });
                renderMessages();
                speakText(text);
             } catch(e) { updateVoiceStatus('idle'); }
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(cleanText(text));
            u.lang = 'hi-IN';
            u.onstart = () => { if(isVoiceMode) updateVoiceStatus('speaking'); };
            u.onend = () => { if(isVoiceMode) updateVoiceStatus('idle'); };
            window.speechSynthesis.speak(u);
        }

        const handleSwadhyayFile = (e) => {
            const f = e.target.files[0];
            if(f) {
                swadhyayPaper = f;
                el('swadhyay-filename').textContent = f.name;
                show('swadhyay-file-status');
                el('btn-solve-swadhyay').disabled = false;
            }
        };

        async function solveSwadhyay() {
            const btn = el('btn-solve-swadhyay');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> Analyzing...`;
            lucide.createIcons();
            btn.disabled = true;
            
            // Text only fallback for stability
            const apiMessages = [
                { role: "system", content: "You are a teacher. Solve the paper." },
                { role: "user", content: `Please solve the attached question paper: ${swadhyayPaper.name}. Format nicely.` }
            ];

            try {
                const text = await callBackendAI(apiMessages);
                el('solution-content').innerHTML = parseMarkdown(text);
                hide('swadhyay-upload-area');
                show('swadhyay-solution-area');
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'swadhyay'), {
                     title: swadhyayPaper.name, solution: text, updatedAt: serverTimestamp()
                });
            } catch(e) { alert("Error solving"); }
            btn.innerHTML = "Solve Now";
            btn.disabled = false;
        }

        function downloadSolutionPDF() {
            html2canvas(el('solution-print-area')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save("solution.pdf");
            });
        }

        async function startVisualClass() {
            const topic = el('visuals-topic-input').value;
            if(!topic) return;
            const container = el('visualizer-container');
            container.innerHTML = `<div class="text-center animate-pulse"><p class="text-cyan-200">GENERATING CLASS...</p></div>`;
            
            try {
                const script = await callBackendAI([{role:"user", content:`Explain ${topic} simply in 150 words.`}]);
                container.innerHTML = `<div class="text-cyan-400 text-xl font-bold p-8 border border-cyan-500 rounded-xl">${topic}</div>`;
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'smartclass'), { topic, script, imageSrc: null, createdAt: serverTimestamp() });
                hide('visuals-input-group');
                show('visuals-script-group');
                el('visuals-script-text').textContent = script;
                speakText(script);
            } catch(e) { container.innerHTML = `<p class="text-red-500">Error</p>`; }
        }

        function exitVisuals() {
            window.speechSynthesis.cancel();
            hide('visuals-script-group');
            show('visuals-input-group');
            el('visualizer-container').innerHTML = `<div id="visuals-placeholder" class="text-center text-gray-500 flex flex-col items-center"><div class="w-24 h-24 bg-cyan-900/20 rounded-full flex items-center justify-center mb-4 border border-cyan-500/20"><i data-lucide="lightbulb" class="w-12 h-12 text-cyan-400/50"></i></div><p class="text-lg font-medium text-gray-400">What do you want to learn?</p></div>`;
            lucide.createIcons();
        }

        function switchTab(tab) {
            ['chat','swadhyay','visuals','earnings'].forEach(t => hide(`tab-${t}`));
            hide('chat-input-container');
            show(`tab-${tab}`);
            if(tab === 'chat') show('chat-input-container');
        }

        async function saveChat() {
            if(!currentUser) return;
            const id = currentSessionId || Date.now().toString();
            currentSessionId = id;
            const validMsgs = currentMessages.filter(m => !m.isLoading).map(m => ({
                role: m.role, content: m.content, file: m.file ? { type: m.file.type, name: 'File' } : null
            }));
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'chats', id), {
                messages: validMsgs, title: currentMessages[0]?.content.slice(0, 30) || "Chat", updatedAt: serverTimestamp()
            }, { merge: true });
        }

        function cleanText(text) { return text.replace(/[*#`|]/g, '').replace(/\[.*?\]/g, '').trim(); }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function showImage(src) { el('image-viewer-content').src = src; show('image-viewer'); }
        function getPersonaInstruction(voiceId, profile) { return `Role: Educational Mentor. Voice: ${voiceId}. Student Class: ${profile?.class || 'Unknown'}. Keep it simple.`; }

        function parseMarkdown(text) {
             if (!text) return "";
             let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
             return html;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>