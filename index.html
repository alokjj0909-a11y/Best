<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadhaiSetu AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF Generation Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Custom Styles -->
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .animate-pulse-ring { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .animate-breathe { animation: breathe 8s infinite ease-in-out; }

        /* Utility for markdown tables */
        .markdown-table { width: 100%; border-collapse: collapse; border: 2px solid #0e7490; margin-bottom: 16px; font-size: 14px; font-family: sans-serif; }
        .markdown-table th { border: 1px solid #0e7490; padding: 10px; background-color: #cffafe; color: #155e75; font-weight: bold; text-align: center; }
        .markdown-table td { border: 1px solid #0e7490; padding: 8px; color: #1f2937; vertical-align: top; white-space: pre-wrap; }
        .markdown-table tr:nth-child(even) { background-color: #f0fdfa; }
        
        /* Markdown content styles */
        .prose strong { font-weight: 800; color: #000; }
        .prose h3 { font-size: 1.125rem; font-weight: 700; color: #164e63; border-bottom: 2px solid rgba(6,182,212,0.3); padding-bottom: 0.25rem; margin-top: 1.5rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="bg-white h-screen overflow-hidden text-gray-800 font-sans selection:bg-cyan-200 selection:text-cyan-900">

    <!-- APP CONTAINER -->
    <div id="app" class="relative h-full w-full">
        
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="hidden absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center text-center p-4 overflow-hidden">
            <div class="absolute w-96 h-96 bg-cyan-500/20 rounded-full blur-3xl -top-20 -left-20"></div>
            <div class="absolute w-96 h-96 bg-blue-500/20 rounded-full blur-3xl bottom-10 right-10"></div>
            
            <div class="relative flex items-center justify-center w-24 h-24 mb-8 z-10 animate-float bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl shadow-lg shadow-cyan-500/30 text-white">
                <i data-lucide="shield" class="absolute w-[120%] h-[120%] opacity-20"></i>
                <i data-lucide="graduation-cap" class="w-12 h-12 relative z-10"></i>
            </div>
            
            <h1 class="text-5xl font-extrabold text-white mb-2 z-10 tracking-tight">Padhai<span class="text-cyan-400">Setu</span> AI</h1>
            <p class="text-gray-400 mb-12 z-10 max-w-sm">Aapka Smart Educational Assistant. Login karein aur padhai shuru karein!</p>
            
            <div class="flex flex-col gap-4 w-full max-w-sm z-10 px-4">
                <button id="btn-login-google" class="w-full bg-white text-black py-3.5 rounded-xl font-bold text-lg hover:bg-gray-100 hover:scale-105 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)] flex items-center justify-center gap-3">
                    <svg viewBox="0 0 24 24" class="w-6 h-6"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Continue with Google
                </button>
                <button id="btn-login-guest" class="w-full bg-slate-800/80 text-gray-300 py-3.5 rounded-xl font-bold text-lg hover:bg-slate-700 hover:text-white transition-all border border-slate-700 backdrop-blur-sm">Guest Login (Testing)</button>
            </div>
        </div>

        <!-- 2. ONBOARDING SCREEN -->
        <div id="onboarding-screen" class="hidden absolute inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md space-y-4">
                <div class="text-center mb-6">
                    <div class="relative flex items-center justify-center w-16 h-16 mx-auto mb-2 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl text-white">
                         <i data-lucide="graduation-cap" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Setup Profile</h2>
                </div>
                <select id="onboard-class" class="w-full p-3 border rounded-lg bg-white"><option value="">Select Class</option></select>
                <select id="onboard-state" class="w-full p-3 border rounded-lg bg-white"><option value="">Select State</option></select>
                <div id="board-select-container" class="hidden animate-in fade-in slide-in-from-top-2">
                    <select id="onboard-board" class="w-full p-3 border rounded-lg bg-white"><option value="">Select Board</option></select>
                </div>
                <button id="btn-save-profile" disabled class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold hover:bg-cyan-700 disabled:opacity-50 mt-2 transition">Start Learning</button>
            </div>
        </div>

        <!-- 3. MAIN APP INTERFACE -->
        <div id="main-interface" class="hidden flex h-full">
            
            <!-- SIDEBAR -->
            <div id="sidebar" class="-translate-x-full md:translate-x-0 fixed md:relative z-40 w-72 h-full bg-gray-900 text-white transition-transform duration-300 flex flex-col border-r border-gray-800 shadow-2xl">
                <div class="p-4 flex justify-between items-center">
                    <div class="font-bold text-xl flex items-center gap-2">
                         <div class="w-8 h-8 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center"><i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i></div>
                         PadhaiSetu
                    </div>
                    <button id="btn-close-sidebar" class="md:hidden p-1 hover:bg-gray-800 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div class="p-3">
                    <button id="btn-new-chat" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-xl flex gap-2 items-center justify-center text-sm font-bold transition shadow-lg shadow-cyan-900/20">
                        <i data-lucide="plus" class="w-5 h-5"></i> New Chat
                    </button>
                </div>

                <div class="px-2 mb-2 flex gap-1 bg-gray-800 p-1 mx-3 rounded-lg">
                    <button data-history-tab="chat" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition bg-gray-600 text-white shadow">CHATS</button>
                    <button data-history-tab="swadhyay" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-gray-200">PAPERS</button>
                    <button data-history-tab="smartclass" class="history-tab-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-gray-200">TOPICS</button>
                </div>
                
                <div class="px-4 py-2 space-y-1">
                    <button id="btn-nav-smartclass" class="w-full flex items-center gap-3 p-2 rounded-lg text-sm transition text-gray-300 hover:bg-gray-800">
                        <i data-lucide="monitor-play" class="w-4 h-4"></i> Smart Class <span class="ml-auto text-[10px] bg-cyan-500 text-black px-1.5 rounded font-bold">PRO</span>
                    </button>
                </div>

                <div id="history-list" class="flex-1 overflow-y-auto px-3 space-y-1 scrollbar-hide">
                    <!-- History items injected here -->
                </div>
                
                <div class="p-4 bg-gray-900 border-t border-gray-800">
                    <div class="flex items-center gap-3">
                        <div id="user-avatar" class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center font-bold">G</div>
                        <p id="user-name" class="text-sm truncate flex-1 font-medium">Guest Student</p>
                        <button id="btn-logout"><i data-lucide="log-out" class="w-5 h-5 text-gray-400 hover:text-white"></i></button>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-1 flex flex-col h-full relative bg-white">
                
                <!-- HEADER -->
                <header class="h-16 border-b flex items-center justify-between px-4 bg-white/80 backdrop-blur-md z-30 sticky top-0">
                    <button id="btn-open-sidebar" class="md:hidden p-2"><i data-lucide="menu" class="w-6 h-6 text-gray-600"></i></button>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1.5 border border-gray-200 cursor-pointer relative group hover:border-cyan-400 transition">
                            <span class="text-cyan-600"><i id="current-voice-icon" data-lucide="heart" class="w-4 h-4"></i></span>
                            <select id="voice-select" class="bg-transparent border-none text-sm font-medium text-gray-700 focus:ring-0 cursor-pointer appearance-none pr-4 outline-none">
                                <!-- Voice options injected -->
                            </select>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 absolute right-2 pointer-events-none"></i>
                        </div>
                    </div>
                    <button id="btn-nav-swadhyay" class="flex items-center gap-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-md hover:shadow-lg hover:scale-105 transition transform">
                        <i data-lucide="indian-rupee" class="w-4 h-4"></i> Earnings
                    </button>
                </header>

                <!-- TAB: CHAT -->
                <div id="tab-chat" class="flex-1 overflow-y-auto p-4 space-y-6 pb-24 scroll-smooth">
                    <!-- Messages injected here -->
                    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center p-8">
                        <div class="w-20 h-20 bg-cyan-50 rounded-full flex items-center justify-center mb-6"><i data-lucide="sparkles" class="w-10 h-10 text-cyan-500"></i></div>
                        <h2 id="welcome-text" class="text-2xl font-bold text-gray-800 mb-2">Namaste!</h2>
                        <p class="text-gray-500 max-w-sm mb-8">Ask me anything from your syllabus.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg">
                            <button id="btn-start-voice-empty" class="flex items-center gap-3 p-4 bg-gray-900 text-white rounded-xl shadow-lg hover:shadow-xl transition group transform hover:-translate-y-1">
                                <div class="bg-white/10 p-2 rounded-full group-hover:bg-white/20"><i data-lucide="headphones" class="w-6 h-6"></i></div>
                                <div class="text-left"><p class="font-bold">Voice Mode</p><p class="text-xs opacity-70">Tap Mic to Chat</p></div>
                            </button>
                            <div class="flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:border-cyan-400 transition cursor-default">
                                <div class="bg-cyan-50 p-2 rounded-full"><i data-lucide="upload" class="w-6 h-6 text-cyan-600"></i></div>
                                <div class="text-left"><p class="font-bold text-gray-800">Solve Paper</p><p class="text-xs text-gray-500">Use Earnings button</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: SWADHYAY -->
                <div id="tab-swadhyay" class="hidden flex-1 overflow-y-auto p-6 bg-gray-50 relative">
                    <div class="sticky top-0 z-50 flex justify-end mb-2">
                        <button id="btn-close-swadhyay" class="bg-white/90 p-2 rounded-full shadow-md text-red-500 hover:bg-red-50 border border-gray-200 backdrop-blur-sm transition-all transform active:scale-95">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-cyan-800 border-b pb-4">
                            <div class="bg-cyan-100 p-2 rounded-full"><i data-lucide="upload" class="w-6 h-6 text-cyan-600"></i></div>
                            Swadhyay Paper / Question Paper Solver
                        </h2>
                        
                        <!-- Upload Area -->
                        <div id="swadhyay-upload-area">
                            <div id="swadhyay-dropzone" class="bg-white p-10 rounded-3xl shadow-lg border-2 border-dashed border-cyan-200 mb-8 relative group cursor-pointer hover:border-cyan-500 hover:bg-cyan-50/20 transition-all flex flex-col items-center justify-center min-h-[250px]">
                                <div class="bg-blue-50 p-5 rounded-full group-hover:bg-blue-100 transition shadow-sm mb-4">
                                    <i data-lucide="scan-line" class="w-12 h-12 text-blue-500 animate-pulse"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Scan Question Paper</h3>
                                <p class="text-sm text-gray-500 mt-1">Upload PDF, Image or Text file</p>
                                <div id="swadhyay-file-status" class="hidden mt-6 px-5 py-2 bg-green-100 text-green-800 rounded-full flex items-center gap-2 font-bold shadow-sm animate-in zoom-in">
                                    <i data-lucide="file-check" class="w-5 h-5"></i><span id="swadhyay-filename"></span> Ready
                                </div>
                            </div>
                            <input type="file" id="swadhyay-file-input" class="hidden" accept=".jpg,.jpeg,.png,.pdf,.txt">
                            
                            <button id="btn-solve-swadhyay" disabled class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-cyan-500/40 transition-all disabled:opacity-50 flex items-center justify-center gap-3 transform active:scale-95">
                                <i data-lucide="sparkles" class="w-6 h-6"></i> Solve Now
                            </button>
                        </div>

                        <!-- Solution Area -->
                        <div id="swadhyay-solution-area" class="hidden mt-8 bg-white rounded-2xl shadow-xl border border-cyan-100 overflow-hidden animate-in fade-in slide-in-from-bottom-4">
                            <div id="solution-print-area" class="p-10 bg-white relative">
                                <h3 class="text-2xl font-bold text-cyan-800 border-b-2 border-cyan-500 pb-4 mb-6">PadhaiSetu Solution</h3>
                                <div id="solution-content" class="prose max-w-none text-gray-800 font-sans leading-relaxed text-lg"></div>
                            </div>
                            <div class="p-6 bg-gray-50 border-t flex justify-end gap-4 no-print">
                                <button id="btn-pdf-download" class="flex items-center gap-2 bg-white text-red-600 font-bold px-6 py-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5">
                                    <i data-lucide="download" class="w-5 h-5"></i> Download PDF
                                </button>
                                <button id="btn-solution-listen" class="flex items-center gap-2 text-cyan-600 font-medium">
                                    <i data-lucide="volume-2" class="w-5 h-5"></i> Listen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: VISUALS (SMART CLASS) -->
                <div id="tab-visuals" class="hidden flex-1 bg-gray-950 text-white flex flex-col h-full relative overflow-hidden font-sans">
                     <div class="z-10 flex flex-col h-full p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold flex items-center gap-2 text-cyan-400 tracking-wide">
                                <i data-lucide="school" class="w-6 h-6 text-cyan-400 drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]"></i> Smart Class 
                                <span class="text-[10px] bg-cyan-500/20 text-cyan-300 px-1.5 py-0.5 rounded border border-cyan-500/30">VISUAL LEARNING</span>
                            </h2>
                            <button id="btn-close-smartclass" class="p-2 bg-white/10 rounded-full hover:bg-red-500/20 hover:text-red-400 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        
                        <div id="visualizer-container" class="flex-1 rounded-2xl relative overflow-hidden flex items-center justify-center mb-4 bg-black border border-cyan-500/20 shadow-[0_0_30px_rgba(6,182,212,0.1)]">
                            <!-- Dynamic Content -->
                            <div id="visuals-placeholder" class="text-center text-gray-500 flex flex-col items-center">
                                <div class="w-24 h-24 bg-cyan-900/20 rounded-full flex items-center justify-center mb-4 border border-cyan-500/20">
                                    <i data-lucide="lightbulb" class="w-12 h-12 text-cyan-400/50"></i>
                                </div>
                                <p class="text-lg font-medium text-gray-400">What do you want to learn?</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-900/80 backdrop-blur-xl p-4 rounded-2xl border border-cyan-500/20 shadow-lg">
                            <div id="visuals-input-group" class="flex flex-col gap-3">
                                <div class="flex gap-2 bg-black/40 p-1.5 rounded-xl border border-cyan-500/30 focus-within:border-cyan-500/60 transition-colors">
                                    <input id="visuals-topic-input" placeholder="e.g. Solar System, Heart..." class="flex-1 bg-transparent border-none text-white w-full focus:ring-0 outline-none text-sm placeholder-gray-500 px-2">
                                    <button id="btn-start-visuals" class="bg-cyan-600 hover:bg-cyan-500 text-black px-6 py-2 rounded-lg font-bold transition disabled:opacity-50 shadow-[0_0_10px_rgba(8,145,178,0.5)] flex items-center gap-2 text-sm">
                                        <i data-lucide="play" class="w-4 h-4 fill-current"></i> Start Class
                                    </button>
                                </div>
                                <div class="flex justify-between items-center px-1">
                                    <div class="flex items-center gap-2 text-xs text-gray-400">
                                        <div class="p-1 bg-white/5 rounded"><i data-lucide="languages" class="w-3 h-3 text-cyan-400"></i></div>
                                        <select id="visuals-lang-select" class="bg-transparent outline-none text-gray-300 cursor-pointer hover:text-white uppercase font-bold text-[10px]">
                                            <option value="Hindi" class="text-black">Hindi</option>
                                            <option value="English" class="text-black">English</option>
                                            <option value="Gujarati" class="text-black">Gujarati</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="visuals-script-group" class="hidden flex flex-col gap-3">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-cyan-500 font-mono tracking-wider font-bold">
                                        <i data-lucide="school" class="w-3 h-3 inline mr-1"></i> SMART EXPLANATION
                                    </span>
                                    <div class="flex gap-2">
                                        <button id="btn-visuals-pause" class="text-white flex items-center gap-2 hover:text-cyan-300 bg-cyan-600 px-4 py-1.5 rounded-full shadow-[0_0_10px_rgba(8,145,178,0.5)] transition">
                                            <i data-lucide="pause" class="w-3 h-3 fill-current"></i> PAUSE
                                        </button>
                                        <button id="btn-visuals-reset" class="text-red-400 hover:text-white bg-white/5 p-1.5 rounded-full"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                                        <button id="btn-visuals-exit" class="text-gray-400 hover:text-white px-3 py-1.5 rounded-full hover:bg-white/10 transition">EXIT</button>
                                    </div>
                                </div>
                                <div class="max-h-32 overflow-y-auto pr-1 bg-black/20 p-2 rounded-lg border border-white/5">
                                    <p id="visuals-script-text" class="text-sm text-gray-300 leading-relaxed"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: EARNINGS -->
                <div id="tab-earnings" class="hidden flex-1 p-6 flex flex-col items-center justify-center text-gray-500 relative">
                     <button id="btn-close-earnings" class="absolute top-6 right-6 p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
                     <i data-lucide="trending-up" class="w-16 h-16 text-gray-300 mb-4"></i>
                     <h3 class="text-xl font-bold">Earnings Dashboard</h3>
                     <p>Coming Soon</p>
                </div>

                <!-- CHAT INPUT AREA -->
                <div id="chat-input-container" class="p-3 bg-white border-t sticky bottom-0 z-20">
                    <div class="max-w-3xl mx-auto relative">
                        <!-- Attachment Menu -->
                        <div id="attachment-menu" class="hidden absolute bottom-full left-0 mb-3 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 flex flex-col gap-1 w-48 animate-in slide-in-from-bottom-5 z-30">
                             <button id="btn-camera" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl text-left transition text-gray-700"><div class="bg-gray-100 p-2 rounded-full"><i data-lucide="camera" class="w-5 h-5"></i></div> Camera</button>
                             <button id="btn-document" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl text-left transition text-gray-700"><div class="bg-gray-100 p-2 rounded-full"><i data-lucide="paperclip" class="w-5 h-5"></i></div> Document / Photo</button>
                        </div>
                        <input type="file" id="chat-file-input" class="hidden" accept="*/*">
                        <input type="file" id="chat-camera-input" class="hidden" accept="image/*" capture="environment">
                        
                        <!-- File Preview -->
                        <div id="chat-file-preview" class="hidden absolute bottom-full left-0 mb-4 p-2 bg-white rounded-xl shadow-lg border border-gray-100 animate-in fade-in slide-in-from-bottom-2 flex items-center gap-3">
                             <div id="preview-icon-area" class="h-16 w-16 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200 overflow-hidden"></div>
                             <span id="preview-filename" class="text-xs text-gray-600 max-w-[100px] truncate"></span>
                             <button id="btn-remove-attachment" class="absolute -top-2 -right-2 bg-gray-800 text-white rounded-full p-1 hover:bg-black"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>

                        <div class="flex items-end gap-3 bg-gray-100 p-2 rounded-[26px] border border-transparent focus-within:border-gray-300 focus-within:bg-white focus-within:shadow-sm transition-all">
                            <button id="btn-toggle-attach" class="p-3 rounded-full transition-transform bg-gray-200 hover:bg-gray-300 text-gray-700"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            <textarea id="chat-input" placeholder="Message PadhaiSetu..." class="flex-1 bg-transparent border-none focus:ring-0 resize-none max-h-32 py-3 text-gray-800 placeholder-gray-500 outline-none" rows="1"></textarea>
                            <div class="flex items-center gap-1">
                                <button id="btn-send-message" class="hidden p-3 bg-black text-white rounded-full hover:opacity-80 transition shadow-md animate-in zoom-in"><i data-lucide="send" class="w-5 h-5"></i></button>
                                <button id="btn-start-voice" class="p-3 bg-gray-900 text-white rounded-full hover:bg-gray-700 transition shadow-md ml-1"><i data-lucide="headphones" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- VOICE OVERLAY -->
        <div id="voice-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-between p-8 animate-in fade-in duration-300 backdrop-blur-xl">
             <div class="w-full flex justify-between text-white/80">
                <div class="flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-5 h-5 text-cyan-400"></i>
                    <span id="voice-mode-status">Voice Mode</span>
                </div>
                <button id="btn-close-voice" class="p-2 bg-white/10 rounded-full hover:bg-white/20"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="flex-1 flex items-center justify-center">
                <div id="voice-orb" class="w-40 h-40 rounded-full bg-gray-800 transition-all duration-500 flex items-center justify-center">
                     <i data-lucide="mic" class="w-12 h-12 text-gray-400"></i>
                </div>
            </div>
            
            <div class="text-center mb-12">
                <p id="voice-text" class="text-2xl font-bold text-white mb-2">Tap Mic to Chat</p>
            </div>
            
            <div class="flex justify-center pb-8">
                <button id="btn-voice-action" class="p-8 rounded-full bg-white text-black hover:scale-105 transition">
                    <i data-lucide="mic" class="w-10 h-10"></i>
                </button>
            </div>
        </div>

        <!-- UPGRADE MODAL -->
        <div id="upgrade-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
            <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden shadow-2xl relative">
                <button id="btn-close-upgrade" class="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="bg-gray-900 text-white p-8 text-center">
                    <div class="inline-block p-4 rounded-full bg-white/10 mb-4"><i data-lucide="crown" class="w-8 h-8 text-yellow-400"></i></div>
                    <h2 class="text-2xl font-bold">Upgrade to Pro</h2>
                </div>
                <div class="p-8 space-y-4">
                    <div class="flex items-center gap-3 text-gray-700 font-medium"><i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i> Unlimited Voice Mode</div>
                    <div class="flex items-center gap-3 text-gray-700 font-medium"><i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i> Homework Solver</div>
                    <div class="flex items-center gap-3 text-gray-700 font-medium"><i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i> PDF Downloads</div>
                    <button id="btn-upgrade-action" class="w-full bg-cyan-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg">Pay â‚¹30/mo</button>
                </div>
            </div>
        </div>

        <!-- IMAGE VIEWER -->
        <div id="image-viewer" class="hidden fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200">
            <button id="btn-close-image" class="absolute top-4 right-4 p-3 bg-white/10 hover:bg-white/20 rounded-full text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            <img id="image-viewer-content" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
        </div>

        <!-- TOAST CONTAINER -->
        <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[70] pointer-events-none"></div>
    </div>
    
    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, updateDoc, increment, collection, query, orderBy, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCxj9wQwwhkgWlJhKUjOsxLQIRvil-C5ns",
          authDomain: "padhaisetu-ced2a.firebaseapp.com",
          databaseURL: "https://padhaisetu-ced2a-default-rtdb.firebaseio.com",
          projectId: "padhaisetu-ced2a",
          storageBucket: "padhaisetu-ced2a.firebasestorage.app",
          messagingSenderId: "635163904849",
          appId: "1:635163904849:web:6b9715b832cb34330a6170"
        };
        const BACKEND_URL = "/api/gemini";
        const CLASSES = Array.from({ length: 12 }, (_, i) => `Class ${i + 1}`);
        const STATES = ["Gujarat", "Maharashtra", "Rajasthan", "Uttar Pradesh", "Bihar", "Madhya Pradesh", "Karnataka", "Tamil Nadu", "Delhi", "Punjab"];
        const BOARDS = ["CBSE", "ICSE", "GSEB", "MSBSHSE", "UPMSP", "RBSE"];
        const AI_VOICES = [
          { name: "Badi Didi (Caring)", id: "Aoede", icon: "heart", gender: "female", pitch: 1.0 }, 
          { name: "Bada Bhai (Cool)", id: "Fenrir", icon: "user", gender: "male", pitch: 0.9 },   
          { name: "Dost (Fun)", id: "Iapetus", icon: "smile", gender: "male", pitch: 1.0 },          
          { name: "Sir (Serious)", id: "Orus", icon: "book-open", gender: "male", pitch: 0.8 }   
        ];

        // --- STATE ---
        const appId = 'padhaisetu-ced2a';
        let app, auth, db, googleProvider;
        let currentUser = null;
        let userProfile = null;
        let currentMessages = [];
        let currentSessionId = null;
        let chatHistory = [];
        let swadhyayHistory = [];
        let smartClassHistory = [];
        let activeHistoryTab = 'chat';
        let attachedFile = null;
        let selectedVoice = "Aoede";
        let isVoiceMode = false;
        let voiceState = 'idle'; // idle, recording, processing, speaking
        let swadhyayPaper = null;
        let currentSmartSession = null;
        
        // Refs for cleanup
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let audioContext = null;

        // --- DOM HELPER ---
        const el = id => document.getElementById(id);
        const show = id => el(id).classList.remove('hidden');
        const hide = id => el(id).classList.add('hidden');
        
        // --- INITIALIZATION ---
        function init() {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                googleProvider = new GoogleAuthProvider();
                
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) {
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                        try {
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                userProfile = docSnap.data();
                                renderApp();
                            } else {
                                renderOnboarding();
                            }
                        } catch (e) { console.error(e); renderOnboarding(); }
                        setupRealtimeListeners(user.uid);
                    } else {
                        renderLogin();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error", e);
                alert("Firebase Error. Check console.");
            }
            
            lucide.createIcons();
            populateDropdowns();
            populateVoiceSelect();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Sidebar History Tabs
            document.querySelectorAll('.history-tab-btn').forEach(btn => {
                btn.onclick = () => {
                    // UI Update
                    document.querySelectorAll('.history-tab-btn').forEach(b => {
                        b.classList.remove('bg-gray-600', 'text-white', 'shadow');
                        b.classList.add('text-gray-400', 'hover:text-gray-200');
                    });
                    btn.classList.remove('text-gray-400', 'hover:text-gray-200');
                    btn.classList.add('bg-gray-600', 'text-white', 'shadow');
                    
                    // State Update
                    activeHistoryTab = btn.getAttribute('data-history-tab');
                    renderSidebar();
                };
            });
        }

        function populateDropdowns() {
            CLASSES.forEach(c => el('onboard-class').add(new Option(c, c)));
            STATES.forEach(s => el('onboard-state').add(new Option(s, s)));
            BOARDS.forEach(b => el('onboard-board').add(new Option(b, b)));
        }

        function populateVoiceSelect() {
            const select = el('voice-select');
            select.innerHTML = '';
            AI_VOICES.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name;
                select.appendChild(opt);
            });
            select.value = selectedVoice;
        }

        // --- RENDER LOGIC ---
        function resetViews() {
            hide('login-screen');
            hide('onboarding-screen');
            hide('main-interface');
        }

        function renderLogin() {
            resetViews();
            show('login-screen');
        }

        function renderOnboarding() {
            resetViews();
            show('onboarding-screen');
        }

        function renderApp() {
            resetViews();
            show('main-interface');
            updateUserUI();
        }

        function updateUserUI() {
            if(currentUser) {
                el('user-name').textContent = currentUser.displayName || 'Guest Student';
                el('user-avatar').textContent = (currentUser.displayName?.[0] || 'G').toUpperCase();
            }
        }

        // --- AUTH ACTIONS ---
        el('btn-login-google').onclick = async () => {
             try { await signInWithPopup(auth, googleProvider); } 
             catch (e) { console.warn("Fallback to Guest"); await signInAnonymously(auth); }
        };
        el('btn-login-guest').onclick = async () => await signInAnonymously(auth);
        el('btn-logout').onclick = () => signOut(auth);

        el('btn-save-profile').onclick = async () => {
             const cls = el('onboard-class').value;
             const state = el('onboard-state').value;
             const board = el('onboard-board').value;
             if(currentUser && cls && state) {
                 const data = { class: cls, state, board, isPro: false, earnings: 0, uploads: 0, email: currentUser.email, displayName: currentUser.displayName || 'Guest' };
                 await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), data);
                 userProfile = data;
                 renderApp();
             }
        };

        // Onboarding logic
        const checkOnboard = () => {
             const cls = el('onboard-class').value;
             const state = el('onboard-state').value;
             const board = el('onboard-board').value;
             const needsBoard = cls === 'Class 10' || cls === 'Class 12';
             
             if(needsBoard) show('board-select-container'); else hide('board-select-container');
             
             const valid = cls && state && (!needsBoard || board);
             el('btn-save-profile').disabled = !valid;
        };
        el('onboard-class').onchange = checkOnboard;
        el('onboard-state').onchange = checkOnboard;
        el('onboard-board').onchange = checkOnboard;

        // --- CHAT LOGIC ---
        function setupRealtimeListeners(uid) {
            // Chats
            const chatQ = query(collection(db, 'artifacts', appId, 'users', uid, 'chats'), orderBy('updatedAt', 'desc'));
            onSnapshot(chatQ, (snap) => {
                chatHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'chat') renderSidebar();
            });
            
            // Swadhyay
            const swadhyayQ = query(collection(db, 'artifacts', appId, 'users', uid, 'swadhyay'), orderBy('updatedAt', 'desc'));
            onSnapshot(swadhyayQ, (snap) => {
                swadhyayHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'swadhyay') renderSidebar();
            });
            
            // SmartClass
            const smartQ = query(collection(db, 'artifacts', appId, 'users', uid, 'smartclass'), orderBy('createdAt', 'desc'));
            onSnapshot(smartQ, (snap) => {
                smartClassHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(activeHistoryTab === 'smartclass') renderSidebar();
            });
        }

        function renderSidebar() {
             const container = el('history-list');
             container.innerHTML = '';
             
             let list = [];
             let type = activeHistoryTab;
             
             if (type === 'chat') list = chatHistory;
             else if (type === 'swadhyay') list = swadhyayHistory;
             else if (type === 'smartclass') list = smartClassHistory;
             
             if(list.length === 0) {
                 container.innerHTML = `<div class="text-gray-600 text-sm text-center py-4">No recent ${type}</div>`;
                 return;
             }

             list.forEach(item => {
                 const div = document.createElement('div');
                 
                 let icon = 'message-circle';
                 let title = item.title || "Untitled";
                 let clickHandler = () => loadChat(item);
                 let deleteHandler = (e) => { e.stopPropagation(); deleteItem(item.id, type); };

                 if (type === 'swadhyay') {
                     icon = 'file-question';
                     title = item.title || "Question Paper";
                     clickHandler = () => loadSwadhyay(item);
                 } else if (type === 'smartclass') {
                     icon = 'film';
                     title = item.topic || "Visual Lesson";
                     clickHandler = () => loadSmartClass(item);
                 }

                 div.className = `group flex items-center gap-3 p-3 rounded-lg text-sm transition cursor-pointer hover:bg-gray-800 text-gray-400 hover:text-gray-200 ${currentSessionId === item.id && activeHistoryTab === 'chat' ? 'bg-gray-800 text-white' : ''}`;
                 div.innerHTML = `
                    <i data-lucide="${icon}" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="truncate flex-1">${title}</span>
                    <button class="btn-del-item p-1.5 hover:bg-red-500/20 text-gray-500 hover:text-red-400 rounded transition opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                 `;
                 div.onclick = clickHandler;
                 div.querySelector('.btn-del-item').onclick = deleteHandler;
                 container.appendChild(div);
             });
             lucide.createIcons();
        }

        function loadChat(chat) {
            currentSessionId = chat.id;
            currentMessages = chat.messages || [];
            renderMessages();
            switchTab('chat');
            if(window.innerWidth < 768) hide('sidebar');
        }
        
        function loadSwadhyay(item) {
            // Need to retrieve solution from object and set it
            el('solution-content').innerHTML = parseMarkdown(item.solution);
            hide('swadhyay-upload-area');
            show('swadhyay-solution-area');
            switchTab('swadhyay');
            if(window.innerWidth < 768) hide('sidebar');
        }
        
        function loadSmartClass(item) {
             // Rehydrate smart class
             currentSmartSession = item;
             // Logic to show it (simplified)
             switchTab('visuals');
             // Populate fields
             el('visuals-topic-input').value = item.topic;
             el('visuals-script-text').textContent = item.script;
             hide('visuals-input-group');
             show('visuals-script-group');
             // Mock image restore if saved
             const container = el('visualizer-container');
             if(item.imageSrc) {
                  container.innerHTML = `<img src="${item.imageSrc}" class="max-w-full max-h-full object-contain animate-breathe">`;
             } else {
                  container.innerHTML = `<div class="text-cyan-400 text-xl font-bold">${item.topic}</div>`;
             }
             if(window.innerWidth < 768) hide('sidebar');
        }

        async function deleteItem(id, type) {
            if(!confirm("Delete this item?")) return;
            try {
                const collectionName = type === 'smartclass' ? 'smartclass' : (type === 'swadhyay' ? 'swadhyay' : 'chats');
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, collectionName, id));
                if(type === 'chat' && currentSessionId === id) {
                    startNewChat();
                } else if (type === 'swadhyay') {
                     // Reset swadhyay view
                     hide('swadhyay-solution-area');
                     show('swadhyay-upload-area');
                     el('swadhyay-file-input').value = '';
                } else if (type === 'smartclass' && currentSmartSession?.id === id) {
                     el('btn-visuals-exit').click();
                }
            } catch(e) { console.error(e); }
        }

        function startNewChat() {
            currentSessionId = null;
            currentMessages = [];
            renderMessages();
            if(window.innerWidth < 768) hide('sidebar');
        }
        el('btn-new-chat').onclick = startNewChat;

        // --- MESSAGING & RENDERING ---
        function renderMessages() {
            const container = el('tab-chat');
            const isEmpty = currentMessages.length === 0;
            
            if(isEmpty) {
                show('empty-state');
                Array.from(container.children).forEach(c => { if(c.id !== 'empty-state') c.remove(); });
                return;
            }
            hide('empty-state');
            
            // Re-render all (simple approach) or append. Re-rendering for simplicity in this port.
            // Remove all existing message bubbles except empty state
            Array.from(container.children).forEach(c => { if(c.id !== 'empty-state') c.remove(); });

            currentMessages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                let contentHTML = '';
                
                if (msg.role === 'user') {
                     let fileHTML = '';
                     if (msg.file) {
                         if(msg.file.type === 'image') {
                             fileHTML = `<img src="${msg.file.data}" class="h-32 w-auto object-cover rounded-xl border border-gray-200 cursor-zoom-in mb-2 view-img-trigger">`;
                         } else {
                             fileHTML = `<div class="flex items-center gap-2 bg-white p-3 rounded-lg border border-gray-200 mb-2"><i data-lucide="file-text" class="w-6 h-6 text-red-500"></i><span class="text-xs font-medium text-gray-700">${msg.file.name}</span></div>`;
                         }
                     }
                     contentHTML = `
                        <div class="bg-gray-100 text-gray-900 rounded-[2rem] rounded-tr-sm px-5 py-3 max-w-[85%] shadow-sm border border-gray-100 self-end">
                            ${fileHTML}
                            <div class="whitespace-pre-wrap text-sm font-medium">${escapeHtml(msg.content)}</div>
                        </div>
                     `;
                } else {
                    // AI Message
                    contentHTML = `
                        <div class="flex gap-3 w-full self-start group">
                            <div class="relative flex items-center justify-center w-8 h-8 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-lg text-white shadow-md"><i data-lucide="graduation-cap" class="w-5 h-5"></i></div>
                            <div class="flex-1 text-gray-800 leading-relaxed pt-1">
                                ${msg.isLoading 
                                    ? `<div class="flex gap-1 items-center h-6">Thinking<span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-75"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-150"></span></div>`
                                    : `<div class="prose text-sm">${parseMarkdown(msg.content)}</div>`
                                }
                                ${!msg.isLoading ? `
                                <div class="mt-3 flex gap-3 items-center">
                                     <button class="btn-speak flex items-center gap-1.5 p-1.5 px-3 bg-white hover:bg-gray-50 rounded-full text-gray-500 hover:text-cyan-600 transition text-xs font-bold border border-gray-200 shadow-sm">
                                        <i data-lucide="volume-2" class="w-3.5 h-3.5"></i> <span>Listen</span>
                                     </button>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                bubble.innerHTML = contentHTML;
                container.appendChild(bubble);
                
                // Attach Events
                const imgTrigger = bubble.querySelector('.view-img-trigger');
                if(imgTrigger) imgTrigger.onclick = () => showImage(imgTrigger.src);
                
                const speakBtn = bubble.querySelector('.btn-speak');
                if(speakBtn) speakBtn.onclick = () => speakText(msg.content);
            });
            
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        // --- SEND LOGIC ---
        async function handleSend() {
            const inputEl = el('chat-input');
            const text = inputEl.value.trim();
            if (!text && !attachedFile) return;

            const userMsg = { role: 'user', content: text, file: attachedFile };
            currentMessages.push(userMsg);
            
            // Add Loading
            currentMessages.push({ role: 'ai', content: '', isLoading: true });
            
            inputEl.value = '';
            setAttachedFile(null);
            renderMessages();
            
            // Logic to call API
            try {
                const history = currentMessages.filter(m => !m.isLoading && m !== userMsg).map(m => `${m.role==='user'?'Student':'AI'}: ${m.content}`).join('\n').slice(-3000);
                const sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                
                let parts = [];
                parts.push({ text: `Chat History:\n${history}\n\nUser Profile: Class ${userProfile.class}\n` });
                
                if (userMsg.file && userMsg.file.type === 'image') {
                    const b64 = userMsg.file.data.split(',')[1];
                    parts.push({ inlineData: { data: b64, mimeType: "image/jpeg" } });
                }
                parts.push({ text: text || "Explain this image." });

                const payload = {
                    mode: 'text',
                    contents: [{ parts: parts }],
                    systemInstruction: sysPrompt
                };

                const response = await callBackendAI(payload);
                const aiText = parseAIResponse(response);
                
                // Replace loading with actual
                currentMessages.pop(); // Remove loading
                currentMessages.push({ role: 'ai', content: aiText });
                
                saveChat();
                renderMessages();
                
                if(isVoiceMode) speakText(aiText);

            } catch (e) {
                console.error(e);
                currentMessages.pop();
                currentMessages.push({ role: 'ai', content: "Sorry, network error." });
                renderMessages();
            }
        }

        el('btn-send-message').onclick = handleSend;
        el('chat-input').onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
        el('chat-input').oninput = (e) => {
             const hasText = e.target.value.trim().length > 0;
             if(hasText || attachedFile) { show('btn-send-message'); } else { hide('btn-send-message'); }
        };

        // --- BACKEND AI ---
        async function callBackendAI(payload) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (e) { return { error: "Failed to fetch" }; }
        }

        function parseAIResponse(res) {
    if (!res) return "Thinking failed.";

    // OpenAI / Gemini compatible
    if (res.choices && res.choices[0]?.message?.content) {
        return res.choices[0].message.content.trim();
    }

    // Custom backend fallback
    if (res.text) return res.text;

    if (res.error) return "Thinking failed.";

    return "Could not understand.";
}

        function getPersonaInstruction(voiceId, profile) {
              const voiceMap = {
                  "Aoede": "Role: Badi Didi (Caring Elder Sister). Sweet, protective.",
                  "Fenrir": "Role: Bada Bhai (Cool Elder Brother). Motivating, practical.",
                  "Iapetus": "Role: Dost (Best Friend). Casual, slang, funny.",
                  "Orus": "Role: Sir (Strict Teacher). Disciplined, formal."
              };
              return `You are NOT AI. You are a human mentor. ${voiceMap[voiceId] || ""}. Student is in ${profile.class}. Keep it educational but in character.`;
        }

        // --- FILE HANDLING ---
        function setAttachedFile(file) {
            attachedFile = file;
            const preview = el('chat-file-preview');
            const inputArea = el('chat-input');
            
            if(file) {
                show('chat-file-preview');
                el('preview-filename').textContent = file.name;
                const iconArea = el('preview-icon-area');
                if(file.type === 'image') {
                    iconArea.innerHTML = `<img src="${file.data}" class="w-full h-full object-cover">`;
                } else {
                    iconArea.innerHTML = `<i data-lucide="file-text" class="w-8 h-8 text-gray-500"></i>`;
                    lucide.createIcons();
                }
                show('btn-send-message');
            } else {
                hide('chat-file-preview');
                if(inputArea.value.trim().length === 0) hide('btn-send-message');
            }
        }

        const handleFile = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = () => setAttachedFile({ data: reader.result, type: f.type.startsWith('image/')?'image':'file', name: f.name });
            reader.readAsDataURL(f);
            hide('attachment-menu');
        };
        el('chat-file-input').onchange = handleFile;
        el('chat-camera-input').onchange = handleFile;
        el('btn-remove-attachment').onclick = () => setAttachedFile(null);
        
        el('btn-toggle-attach').onclick = () => {
             const menu = el('attachment-menu');
             menu.classList.toggle('hidden');
        };
        el('btn-camera').onclick = () => el('chat-camera-input').click();
        el('btn-document').onclick = () => el('chat-file-input').click();

        // --- VOICE MODE ---
        function startVoiceMode() {
            isVoiceMode = true;
            show('voice-overlay');
            updateVoiceStatus('idle');
        }
        
        function updateVoiceStatus(status) {
            voiceState = status;
            const orb = el('voice-orb');
            const txt = el('voice-text');
            const icon = orb.querySelector('svg') || orb.querySelector('i');
            
            orb.className = "w-40 h-40 rounded-full transition-all duration-500 flex items-center justify-center ";
            
            if(status === 'idle') {
                orb.classList.add('bg-gray-800');
                txt.textContent = "Tap Mic to Chat";
            } else if (status === 'listening') {
                orb.classList.add('bg-blue-600', 'scale-110', 'shadow-lg', 'shadow-blue-500/50');
                txt.textContent = "Listening...";
            } else if (status === 'processing') {
                orb.classList.add('bg-white', 'scale-90', 'animate-pulse');
                txt.textContent = "Thinking...";
            } else if (status === 'speaking') {
                orb.classList.add('bg-purple-600', 'scale-125', 'shadow-lg', 'shadow-purple-500/50');
                txt.textContent = "Speaking...";
            }
        }

        async function toggleVoiceRecord() {
            if(voiceState === 'idle') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        updateVoiceStatus('processing');
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                            const b64 = reader.result.split(',')[1];
                            // Send audio to Gemini
                            handleSendAudio(b64);
                        };
                        reader.readAsDataURL(blob);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                    updateVoiceStatus('listening');
                    setTimeout(() => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 5000); // 5s limit for demo
                } catch(e) { alert("Mic error"); }
            } else if (voiceState === 'listening') {
                mediaRecorder.stop();
            } else if (voiceState === 'speaking') {
                window.speechSynthesis.cancel();
                updateVoiceStatus('idle');
            }
        }

        async function handleSendAudio(b64) {
             // Logic: Send audio -> STT -> Text -> Gemini -> Text -> TTS
             // For this demo, we assume the backend handles audio directly or we simulate
             const userMsg = { role: 'user', content: "ðŸŽ¤ (Voice Message)" };
             currentMessages.push(userMsg);
             renderMessages();
             
             try {
                const sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                const payload = {
                    mode: 'text',
                    contents: [{ parts: [{ inlineData: { data: b64, mimeType: "audio/webm" } }, { text: "Listen and reply." }] }],
                    systemInstruction: sysPrompt
                };
                const res = await callBackendAI(payload);
                const text = parseAIResponse(res);
                currentMessages.push({ role: 'ai', content: text });
                renderMessages();
                speakText(text);
             } catch(e) { updateVoiceStatus('idle'); }
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(cleanText(text));
            const voices = window.speechSynthesis.getVoices();
            // Simple voice logic
            u.lang = 'hi-IN';
            if(selectedVoice !== 'Aoede') u.pitch = 0.8;
            
            u.onstart = () => { if(isVoiceMode) updateVoiceStatus('speaking'); };
            u.onend = () => { if(isVoiceMode) updateVoiceStatus('idle'); };
            window.speechSynthesis.speak(u);
        }

        el('btn-start-voice').onclick = startVoiceMode;
        el('btn-start-voice-empty').onclick = startVoiceMode;
        el('btn-voice-action').onclick = toggleVoiceRecord;
        el('btn-close-voice').onclick = () => { isVoiceMode = false; window.speechSynthesis.cancel(); hide('voice-overlay'); };

        // --- SWADHYAY (HOMEWORK) LOGIC ---
        el('btn-nav-swadhyay').onclick = () => switchTab('swadhyay');
        el('btn-close-swadhyay').onclick = () => switchTab('chat');
        
        el('swadhyay-dropzone').onclick = () => el('swadhyay-file-input').click();
        el('swadhyay-file-input').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                swadhyayPaper = f;
                el('swadhyay-filename').textContent = f.name;
                show('swadhyay-file-status');
                el('btn-solve-swadhyay').disabled = false;
            }
        };

        el('btn-solve-swadhyay').onclick = async () => {
            const btn = el('btn-solve-swadhyay');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> Analyzing...`;
            lucide.createIcons();
            btn.disabled = true;
            
            const reader = new FileReader();
            reader.onload = async () => {
                const b64 = reader.result.split(',')[1];
                const payload = {
                    mode: 'text',
                    contents: [{ parts: [
                        { inlineData: { data: b64, mimeType: swadhyayPaper.type } },
                        { text: "Solve this question paper completely. Format nicely in Markdown." }
                    ] }]
                };
                
                try {
                    const res = await callBackendAI(payload);
                    const text = parseAIResponse(res);
                    el('solution-content').innerHTML = parseMarkdown(text);
                    hide('swadhyay-upload-area');
                    show('swadhyay-solution-area');
                    // Save to DB
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'swadhyay'), {
                         title: swadhyayPaper.name, solution: text, updatedAt: serverTimestamp()
                    });
                } catch(e) { alert("Error solving"); }
                btn.innerHTML = "Solve Now";
                btn.disabled = false;
            };
            reader.readAsDataURL(swadhyayPaper);
        };
        
        el('btn-pdf-download').onclick = () => {
            const content = el('solution-print-area');
            html2canvas(content).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save("solution.pdf");
            });
        };

        // --- SMART CLASS LOGIC ---
        el('btn-nav-smartclass').onclick = () => {
            switchTab('visuals');
            if(window.innerWidth < 768) hide('sidebar');
        };
        el('btn-close-smartclass').onclick = () => switchTab('chat');
        el('btn-start-visuals').onclick = async () => {
            const topic = el('visuals-topic-input').value;
            if(!topic) return;
            
            const container = el('visualizer-container');
            container.innerHTML = `<div class="text-center animate-pulse"><i data-lucide="loader-2" class="w-16 h-16 text-cyan-500 animate-spin mx-auto mb-4"></i><p class="text-cyan-200">GENERATING...</p></div>`;
            lucide.createIcons();
            
            // 1. Generate Image
            try {
                // Mocking visual generation for vanilla structure - in real app, call image gen endpoint
                const imgRes = await callBackendAI({
                     mode: 'image',
                     prompt: `Educational diagram of ${topic}, 3D, high definition, clear background`
                });
                
                let imgSrc = '';
                if(imgRes.predictions && imgRes.predictions[0]) {
                     imgSrc = `data:image/png;base64,${imgRes.predictions[0].bytesBase64Encoded}`;
                }
                
                // 2. Generate Script
                const scriptRes = await callBackendAI({
                     mode: 'text',
                     contents: [{ parts: [{ text: `Explain ${topic} like a teacher in 200 words.` }] }]
                });
                const script = parseAIResponse(scriptRes);
                
                // Render
                container.innerHTML = imgSrc 
                    ? `<img src="${imgSrc}" class="max-w-full max-h-full object-contain animate-breathe">` 
                    : `<div class="text-cyan-400 text-xl font-bold">${topic}</div>`;
                
                // Save to history
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'smartclass'), {
                    topic: topic,
                    script: script,
                    imageSrc: imgSrc,
                    createdAt: serverTimestamp()
                });

                hide('visuals-input-group');
                show('visuals-script-group');
                el('visuals-script-text').textContent = script;
                speakText(script);
                
            } catch(e) {
                container.innerHTML = `<p class="text-red-500">Error generating.</p>`;
            }
        };
        
        el('btn-visuals-exit').onclick = () => {
            window.speechSynthesis.cancel();
            hide('visuals-script-group');
            show('visuals-input-group');
            el('visualizer-container').innerHTML = `<div id="visuals-placeholder" class="text-center text-gray-500 flex flex-col items-center"><div class="w-24 h-24 bg-cyan-900/20 rounded-full flex items-center justify-center mb-4 border border-cyan-500/20"><i data-lucide="lightbulb" class="w-12 h-12 text-cyan-400/50"></i></div><p class="text-lg font-medium text-gray-400">What do you want to learn?</p></div>`;
            lucide.createIcons();
        };

        // --- GENERAL UTILS ---
        function switchTab(tab) {
            hide('tab-chat');
            hide('tab-swadhyay');
            hide('tab-visuals');
            hide('tab-earnings');
            hide('chat-input-container');
            
            show(`tab-${tab}`);
            if(tab === 'chat') show('chat-input-container');
        }

        async function saveChat() {
            if(!currentUser) return;
            const id = currentSessionId || Date.now().toString();
            currentSessionId = id;
            
            const validMsgs = currentMessages.filter(m => !m.isLoading).map(m => ({
                role: m.role,
                content: m.content,
                file: m.file ? { type: m.file.type, name: 'File' } : null // Don't save large base64 in list
            }));
            
            const title = currentMessages[0]?.content.slice(0, 30) || "Chat";
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'chats', id), {
                messages: validMsgs,
                title: title,
                updatedAt: serverTimestamp()
            }, { merge: true });
        }

        function cleanText(text) {
            return text.replace(/[*#`|]/g, '').replace(/\[.*?\]/g, '').trim();
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function parseMarkdown(text) {
             if (!text) return "";
             // Simple parser for bold, table, lines
             let html = text
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\n/g, '<br>');
             
             // Very basic table detection (requires proper markdown table structure)
             if (html.includes('|')) {
                 const lines = text.split('\n');
                 let inTable = false;
                 let tableHTML = '<div class="overflow-x-auto"><table class="markdown-table">';
                 let resultHTML = '';
                 
                 lines.forEach(line => {
                     if (line.trim().startsWith('|')) {
                         if (!inTable) { inTable = true; }
                         if (line.includes('---')) return; // Skip separator
                         const cells = line.split('|').filter(c => c.trim() !== '');
                         const tag = tableHTML.includes('tbody') ? 'td' : 'th'; // Heuristic
                         tableHTML += `<tr>${cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('')}</tr>`;
                         if(!tableHTML.includes('tbody') && tag === 'th') tableHTML += '<tbody>';
                     } else {
                         if (inTable) {
                             tableHTML += '</tbody></table></div>';
                             resultHTML += tableHTML;
                             tableHTML = '<div class="overflow-x-auto"><table class="markdown-table">';
                             inTable = false;
                         }
                         resultHTML += line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') + '<br>';
                     }
                 });
                 if(inTable) resultHTML += '</tbody></table></div>';
                 return resultHTML;
             }
             return html;
        }

        function showImage(src) {
            el('image-viewer-content').src = src;
            show('image-viewer');
        }
        el('btn-close-image').onclick = () => hide('image-viewer');
        
        // Sidebar Mobile
        el('btn-open-sidebar').onclick = () => {
             el('sidebar').classList.remove('-translate-x-full');
        };
        el('btn-close-sidebar').onclick = () => {
             el('sidebar').classList.add('-translate-x-full');
        };
        
        // Voice Select
        el('voice-select').onchange = (e) => {
             selectedVoice = e.target.value;
             const v = AI_VOICES.find(x => x.id === selectedVoice);
             const icon = el('current-voice-icon');
             icon.setAttribute('data-lucide', v.icon);
             lucide.createIcons();
        };

        // Start App
        window.addEventListener('load', init);

    </script>
</body>
</html>